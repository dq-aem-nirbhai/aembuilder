<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <title>Create Template</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/template-style.css}">
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container mt-4">
    <a th:href="@{'/view/' + ${projectName}}" class="btn btn-outline-secondary mb-3">‚Üê Back to DeployPage</a>
    <h2>Create Template</h2>

    <form id="templateForm" method="post">
        <input type="hidden" id="projectname" th:value="${projectName}"/>

        <div class="form-group mb-3">
            <label for="templatetype">Template Type:</label>
            <select id="templatetype" name="templatetype" class="form-control" required>
                <option value="">--Select Type--</option>
            </select>
        </div>

        <div class="form-group mb-3">
            <label for="name">Template Name:</label>
            <input type="text" id="name" name="name" class="form-control" required/>
            <div id="name-error" class="text-danger"></div>
        </div>

        <div class="form-group mb-3">
            <label for="title">Title:</label>
            <input type="text" id="title" name="title" class="form-control" required/>
        </div>

        <div class="form-group mb-3">
            <label for="description">Description:</label>
            <input type="text" id="description" name="description" class="form-control" required/>
        </div>

        <div class="form-group mb-3">
            <label for="status">Status:</label>
            <select id="status" name="status" class="form-control" required>
                <option value="">--Select Status--</option>
                <option value="enabled">Enabled</option>
                <option value="draft">Draft</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Create Template</button>
    </form>

    <p id="response" class="mt-3"></p>
</div>

<!-- Spinner overlay -->
<div id="spinner-overlay" class="spinner-overlay d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div th:replace="fragments/navbar :: footer"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let existingTemplates = [];

    const projectnameInput = document.getElementById("projectname");
    const nameInput = document.getElementById("name");
    const titleInput = document.getElementById("title");
    const descriptionInput = document.getElementById("description");
    const statusInput = document.getElementById("status");
    const templatetypeSelect = document.getElementById("templatetype");
    const nameError = document.getElementById("name-error");
    const responseEl = document.getElementById("response");
    const templateForm = document.getElementById("templateForm");
    const spinnerOverlay = document.getElementById("spinner-overlay");

    if (!projectnameInput || !nameInput || !templateForm || !templatetypeSelect) {
        console.error("One or more required elements are missing in the HTML.");
        return;
    }

    const projectName = projectnameInput.value;

    // Disable all form fields initially except template type
    const formFields = document.querySelectorAll('#templateForm input, #templateForm select, #templateForm button');
    formFields.forEach(field => {
        if (field !== templatetypeSelect) {
            field.disabled = true;
        }
    });

    // Enable fields when a template type is selected
    templatetypeSelect.addEventListener("change", () => {
        const enable = templatetypeSelect.value !== "";
        formFields.forEach(field => {
            if (field !== templatetypeSelect) field.disabled = !enable;
        });
    });

    // Fetch template types
    fetch(`/template-types/${projectName}`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            data.forEach(type => {
                const option = document.createElement("option");
                option.value = type;
                option.textContent = type;
                templatetypeSelect.appendChild(option);
            });
        })
        .catch(error => console.error("Error loading template types:", error));

    // Load existing template names when name field is focused
    nameInput.addEventListener("focus", function () {
        if (existingTemplates.length === 0) {
            fetch(`/templates/list/${projectName}`)
                .then(response => response.json())
                .then(data => {
                    existingTemplates = data.map(name => name.toLowerCase());
                })
                .catch(error => console.error("Error fetching existing templates:", error));
        }
    });

    // Check for duplicate name while typing
    nameInput.addEventListener("input", function () {
        const inputName = this.value.trim().toLowerCase();
        nameError.innerText = existingTemplates.includes(inputName) ? "Template already exists." : "";
    });

    // Handle form submission
    templateForm.addEventListener("submit", function (event) {
        event.preventDefault();

        const name = nameInput.value.trim();
        const title = titleInput.value.trim();
        const description = descriptionInput.value.trim();
        const status = statusInput.value;
        const templateType = templatetypeSelect.value;

        if (existingTemplates.includes(name.toLowerCase())) {
            nameError.innerText = "Template already exists.";
            return;
        }

        const data = { name, title, description, status, templateType };

        // Show spinner
        spinnerOverlay.classList.remove("d-none");

        fetch(`/create-template/${projectName}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        })
            .then(response => response.text())
            .then(result => {
                responseEl.style.color = "green";
                responseEl.innerText = result;
                templateForm.reset();
                nameError.innerText = "";
                existingTemplates.push(name.toLowerCase());

                setTimeout(() => {
                    window.location.href = `/view/${projectName}`;
                }, 1000);

                // Reset field disable state
                formFields.forEach(field => {
                    if (field !== templatetypeSelect) field.disabled = true;
                });
            })
            .catch(error => {
                responseEl.style.color = "red";
                responseEl.innerText = "Error: " + error;
            })
            .finally(() => {
                // Hide spinner
                spinnerOverlay.classList.add("d-none");
            });
    });
});
</script>

</body>
</html>
