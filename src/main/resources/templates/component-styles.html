<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Component Styles</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>
<div class="container mt-4">
    <a th:href="@{'/' + ${projectName} + '/template/' + ${templateName}}" class="btn btn-outline-secondary mb-3">&larr; Back</a>
    <h3 th:text="'Component: ' + ${componentName}"></h3>

    <div class="mt-3" th:if="${policies}">
        <h5>Existing Policies</h5>
        <div th:each="p : ${policies}" class="border rounded p-3 mb-3">
            <h6 th:text="${p.title}"></h6>
            <p th:text="${p.description}"></p>
            <p><strong>Default Classes:</strong> <span th:text="${p.defaultClass}"></span></p>
            <div th:each="g : ${p.groups}" class="ms-3">
                <div><strong th:text="'Group: ' + ${g.name} + (${g.combine} ? ' (combined)' : '')"></strong></div>
                <ul>
                    <li th:each="s : ${g.styles}" th:text="${s.name + ' - ' + s.cssClass}"></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h5>Add Policy</h5>
        <form th:action="@{'/' + ${projectName} + '/template/' + ${templateName} + '/' + ${componentName} + '/style'}" method="post" id="policyForm">
            <div class="mb-3">
                <label class="form-label">Policy Title *</label>
                <input type="text" class="form-control" id="policyTitle" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Policy Description</label>
                <input type="text" class="form-control" id="policyDescription">
            </div>
            <div class="mb-3">
                <label class="form-label">Default CSS Classes</label>
                <input type="text" class="form-control" id="defaultClass">
            </div>
            <div id="groupList"></div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addGroup()">Add Group</button>
            <input type="hidden" name="policyJson" id="policyJson"/>
            <button type="submit" class="btn btn-primary ms-2">Save</button>
        </form>
    </div>
</div>
<script>
    function addGroup() {
        const group = document.createElement('div');
        group.className = 'policy-group border p-2 mt-3';
        group.innerHTML = `
            <div class="d-flex mb-2">
                <input type="text" class="form-control me-2 group-name" placeholder="Group Name">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input group-combine">
                    <label class="form-check-label">Styles can be combined</label>
                </div>
                <button type="button" class="btn btn-danger btn-sm ms-2" onclick="removeGroup(this)">Remove Group</button>
            </div>
            <div class="style-list"></div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addStyle(this)">Add Style</button>
        `;
        document.getElementById('groupList').appendChild(group);
        addStyle(group.querySelector('button.btn-outline-secondary'));
    }
    function removeGroup(btn){
        btn.closest('.policy-group').remove();
    }
    function addStyle(btn){
        const groupEl = btn.closest('.policy-group');
        const styleList = groupEl.querySelector('.style-list');
        const div = document.createElement('div');
        div.className = 'row g-2 mb-2 style-row';
        div.innerHTML = `
            <div class="col">
                <input type="text" class="form-control style-name" placeholder="Style Name">
            </div>
            <div class="col">
                <input type="text" class="form-control style-class" placeholder="CSS Classes">
            </div>
            <div class="col-auto d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeStyle(this)">Remove</button>
            </div>`;
        styleList.appendChild(div);
    }
    function removeStyle(btn){
        const list = btn.closest('.style-list');
        const rows = list.querySelectorAll('.style-row');
        if(rows.length > 1){
            btn.closest('.style-row').remove();
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        addGroup();
        document.getElementById('policyForm').addEventListener('submit', (e) => {
            const policy = {
                title: document.getElementById('policyTitle').value,
                description: document.getElementById('policyDescription').value,
                defaultClass: document.getElementById('defaultClass').value,
                groups: []
            };
            document.querySelectorAll('.policy-group').forEach(g => {
                const group = {
                    name: g.querySelector('.group-name').value,
                    combine: g.querySelector('.group-combine').checked,
                    styles: []
                };
                g.querySelectorAll('.style-row').forEach(r => {
                    const name = r.querySelector('.style-name').value;
                    const clazz = r.querySelector('.style-class').value;
                    if(name && clazz){
                        group.styles.push({name: name, cssClass: clazz});
                    }
                });
                policy.groups.push(group);
            });
            document.getElementById('policyJson').value = JSON.stringify(policy);
        });
    });
</script>
</body>
</html>
